---
title: "BLBR_correlated_CpGs"
author: "redgar"
date: '2015-02-06'
output: pdf_document
---

# Load Data
```{r}
setwd("~/Documents/Blood_Brain/")
library(reshape)
library(ggplot2)
library(RColorBrewer)
library(Biobase)
library(mixtools)


#just the 16 for each sample and one brain20 NA
load("cell_adjusted_Mcombat_Bmiq_BLBR_Beta_noreplicates_16_All.RData") #441198     64
combat_BLBR_Beta_adjusted<-combat_BLBR_Beta
load("SNPCpG.RData")
SnpatCpG<-SNPCpG[which(SNPCpG$SNPCpG!=""),]
combat_BLBR_Beta_adjusted<-combat_BLBR_Beta_adjusted[which(!(rownames(combat_BLBR_Beta_adjusted)%in%rownames(SnpatCpG))),]

correlations_BLBR<-read.csv("~/Documents/Blood_Brain/Python/correlation_jan22.csv", sep="\t")                       
colnames(correlations_BLBR)<-c("CpG","BRAIN7","BRAIN10","BRAIN20")
correlations_BLBR$CpG<-rownames(combat_BLBR_Beta)
correlations_BLBR<-correlations_BLBR[which(!(correlations_BLBR$CpG%in%rownames(SnpatCpG))),]
```

#### Any meta data
```{r}
meta<-read.csv("~/Documents/Blood_Brain/SampleInfo.csv")
fix_names<-unlist(lapply(meta$X, function(x) gsub(" ","", x , fixed=TRUE)))
meta$X<-fix_names
meta<-meta[which(meta$X%in%colnames(combat_BLBR_Beta)),]
meta<-meta[match(colnames(combat_BLBR_Beta), meta$X),]
```

### Comethylation Plot Function

```{r}
# Comethylation Plot
Comethylation_Plot<-function(correlations_BLBR, Betas, CpG_Hit_List){
  hits_BLBR<-correlations_BLBR[which(correlations_BLBR$CpG%in%CpG_Hit_List),]
  nrow(hits_BLBR)
  hits_BLBR_PBMC_correlation_melt<-melt(hits_BLBR)
  
  meta$SubNumber<-as.factor(meta$SubjectNumC)
  levels(meta$SubNumber)<-c(1:16)
  BLBR_Beta<-as.data.frame(Betas[which(rownames(Betas)%in%CpG_Hit_List),])
  BLBR_Beta$CpG<-rownames(BLBR_Beta)
  BLBR_Beta<-melt(BLBR_Beta)
  BLBR_Beta<-merge(BLBR_Beta, meta, by.x="variable", by.y="X")
  
  # Comparison highlight
  hits_BLBR$max<-sapply(1:nrow(hits_BLBR), function(x) {
    as.numeric(hits_BLBR[,c(2:4)][x,which(abs(hits_BLBR[x,c(2:4)])==max(abs(hits_BLBR[x,c(2:4)])))][1])})
  hits_BLBR$max_abs<-abs(hits_BLBR$max)
  
  BLBR_Beta$line<-sapply(1:nrow(BLBR_Beta), function(x) {
    hit<-hits_BLBR[which(hits_BLBR$CpG==BLBR_Beta$CpG[x]),]
    region_max_corr<-colnames(hit)[c(2:4)][which(hit[1,c(2:4)]==hit$max[1])]
    if(as.character(BLBR_Beta$TissueType[x])==region_max_corr){"Max_Correlation"}else{"Less Correlated"}})
  
  invisible(sapply(1:nrow(BLBR_Beta), function(x) if(BLBR_Beta$TissueType[x]=="PBMC"){
    BLBR_Beta$line[x]<<-"Max_Correlation"}else{BLBR_Beta$line[x]<<-BLBR_Beta$line[x]}))
  
  #CpG order
  order_cpg<-hits_BLBR$CpG[order(hits_BLBR$max_abs)]
  BLBR_Beta$CpG<-as.factor(BLBR_Beta$CpG)
  BLBR_Beta$CpG<-factor(BLBR_Beta$CpG,levels=rev(order_cpg))
  
  ggplot()+geom_line(aes(SubNumber, value,group=TissueType,color=TissueType,alpha=line),
                     BLBR_Beta, size=1.5)+
    theme_bw()+facet_wrap(~CpG)+
    geom_text(data=hits_BLBR, aes(x=4, y=0.1, label=round(max, 2)),
              colour="black", inherit.aes=FALSE, parse=FALSE)+
    scale_alpha_manual(values = c(0.25, 1))+
    scale_color_manual(values=c("#fb6a4a","#ef3b2c","#cb181d","cornflowerblue"))+
    ylim(0,1)}

```


# Basic Comethylated CpGs
```{r}
# comethylation plot
# Top correlation in any brain region (will plot all brain regions but they may not be the exact same)
top_discordant<-correlations_BLBR[order(correlations_BLBR$BRAIN7),]
top_concordant<-correlations_BLBR[rev(order(correlations_BLBR$BRAIN7)),]

top10discordant<-top_discordant$CpG[1:10]
top10concordant<-top_concordant$CpG[1:10]

Comethylation_Plot(correlations_BLBR,combat_BLBR_Beta_adjusted, top10discordant)
Comethylation_Plot(correlations_BLBR,combat_BLBR_Beta_adjusted, top10concordant)
```



## Choosing Best Variation Measure
```{r}
#Density plots with changing variance cutoff
          # Mvalue looks so weird on cov and 10-100 are not appropriate cutoffs
          Mval<-function(beta) log2(beta/(1-beta))
          combat_BLBR_M_adjusted = apply(combat_BLBR_Beta_adjusted, 1, Mval) # need mvalues for combat
          combat_BLBR_M_adjusted = as.data.frame(combat_BLBR_M_adjusted)
          combat_BLBR_M_adjusted = t(combat_BLBR_M_adjusted)


## Coefficient of variation
  coef<-function(x) (sd(as.numeric(x), na.rm=T)/mean(as.numeric(x), na.rm=T))*100
  coef2<-function(x) (sd(as.numeric(x), na.rm=T)/(1-mean(as.numeric(x), na.rm=T)))*100
  # doesnt work exactly like expression, need to weigh a high mean and low mean equally, before was biased
  # for hypo methylated varibility
  coef_max<-function(x) max(c(coef(x), coef2(x)))
## Standard Deviation
  ?sd
  sd(as.numeric(combat_BLBR_Beta_adjusted[1,]), na.rm=T)
## Median Absolute Deviation
  ?mad
  mad(as.numeric(combat_BLBR_Beta_adjusted[1,]), na.rm=T)
## Full range
  range_betas<-function(x) max(x, na.rm=t)-min(x, na.rm=T)
## 10-90%
  #Nature coomuncations paper on mQTLS
  #We stratify results based on the inter-individual variability of the CpG sites. 
  #Asa measure of variability, we used the 95%-reference range (the difference 
  #betweenthe most and least methylated individuals, among 95% of the individual 
  #formingthe central distribution of methylation values), which is less sensitive 
  #to outliersthan the full range and more readily interpretable than the s.d.
  #Density plots with changing variance cutoff
  Variation<-function(x) {quantile(x, c(0.9), na.rm=T)[[1]]-quantile(x, c(0.1), na.rm=T)[[1]]}


## Correlation of variation measures
Variation_measures<-data.frame(
  coef_max=sapply(1:nrow(combat_BLBR_Beta_adjusted), function(y) coef_max(combat_BLBR_Beta_adjusted[y,])),
  sd=sapply(1:nrow(combat_BLBR_Beta_adjusted), function(y) sd(as.numeric(combat_BLBR_Beta_adjusted[y,]), na.rm=T)),
  mad=sapply(1:nrow(combat_BLBR_Beta_adjusted), function(y)mad(as.numeric(combat_BLBR_Beta_adjusted[y,]), na.rm=T)),
  range_betas=sapply(1:nrow(combat_BLBR_Beta_adjusted), function(y) range_betas(combat_BLBR_Beta_adjusted[y,])),
  quantile=sapply(1:nrow(combat_BLBR_Beta_adjusted), function(y) Variation(combat_BLBR_Beta_adjusted[y,])))

save(Variation_measures, file="Variation_measures.RData")

#variation measures correlation
Plot_var<-Variation_measures[sample(1:nrow(Variation_measures), 100),]
cor_var<-cor(Variation_measures)
library(psych)
pairs.panels(Plot_var)

#Varition measure and methylation mean
Variation_measures$Mean_meth<-rowMeans(combat_BLBR_Beta_adjusted, na.rm=T)
Variation_measures_mean_melt<-melt(Variation_measures, id="Mean_meth")

ggplot(Variation_measures_mean_melt, aes(Mean_meth, value))+geom_smooth()+theme_bw()+facet_wrap(~variable, scales="free_y")


##outlier simulation
Call_all_variances<-function(probes_df){
  Variation_measures<-data.frame(
    coef_max=sapply(1:nrow(probes_df), function(y) coef_max(probes_df[y,])),
    sd=sapply(1:nrow(probes_df), function(y) sd(as.numeric(probes_df[y,]), na.rm=T)),
    mad=sapply(1:nrow(probes_df), function(y)mad(as.numeric(probes_df[y,]), na.rm=T)),
    range_betas=sapply(1:nrow(probes_df), function(y) range_betas(probes_df[y,])),
    quantile=sapply(1:nrow(probes_df), function(y) Variation(probes_df[y,])))}


#one outlier
set.seed(1)
sample_betas<-combat_BLBR_Beta_adjusted[sample(1:nrow(combat_BLBR_Beta_adjusted),10),]
sample_betas_oneout<-sample_betas
sample_betas_oneout$Outlier<-c(0.2, 0.2, 0.8, 0.5, 0.3, 0.5, 0.4, 0.9, 0.4, 0.5)

#two outlier
sample_betas_twoout<-sample_betas_oneout
sample_betas_twoout$Outlier2<-c(0.8, 0.8, 0.01, 0.4, 0.9, 0.8, 0.8, 0.01, 0.01, 1)

#variance of subsets
noout<-Call_all_variances(sample_betas)
oneout<-Call_all_variances(sample_betas_oneout)
twoout<-Call_all_variances(sample_betas_twoout)

#which variance measure inoneout and twoout is closest to no outlier 
data.frame(Variance=colnames(noout),
           OneOutCor=sapply(1:5, function(x) cor(noout[,x], oneout[,x])),
           TwoOutCor=sapply(1:5, function(x) cor(noout[,x], twoout[,x])))



#plot outlier data
sample_betas_twoout$CpG<-rownames(sample_betas_twoout)
sample_betas_twoout_melt<-melt(sample_betas_twoout)
sample_betas_twoout_melt$Outlier<-sapply(1:nrow(sample_betas_twoout_melt), function(x) if(sample_betas_twoout_melt$variable[x]%in%c("Outlier", "Outlier2")){"Outlier"}else{"Inlier"})

ggplot(sample_betas_twoout_melt, aes(CpG, value, color=Outlier))+geom_point(shape=19)+theme_bw()+
  scale_color_manual(values=c("grey","red"))


#outlier check in larger sampl for general use
  load("~/Documents/GEO_data/GEO.RData")
  GEO_betas<-GEO[[1]]
  #one outlier
  set.seed(1)
  sample_betas<-GEO_betas[sample(1:nrow(GEO_betas),10),]
  sample_betas_oneout<-sample_betas
  sample_betas_oneout$Outlier<-c(0.8, 0.8, 0.8, 0.2, 0.5, 0.3, 0.3, 0.2, 0.2, 0.2)
  #two outlier
  sample_betas_twoout<-sample_betas_oneout
  sample_betas_twoout$Outlier2<-c(0.85, 0.85, 0.85, 0.18, 0.45, 0.32, 0.32, 0.24, 0.24, 0.24)
  sample_betas_threeout<-sample_betas_twoout
  sample_betas_threeout$Outlier3<-c(0.75, 0.75, 0.75, 0.23, 0.55, 0.25, 0.25, 0.25, 0.25, 0.25)
  sample_betas_fourout<-sample_betas_threeout
  sample_betas_fourout$Outlier4<-c(0.82, 0.82, 0.82, 0.21, 0.47, 0.33, 0.33, 0.22, 0.22, 0.22)
  sample_betas_fiveout<-sample_betas_fourout
  sample_betas_fiveout$Outlier5<-c(0.77, 0.77, 0.77, 0.25, 0.53, 0.27, 0.27, 0.27, 0.27, 0.27)
  sample_betas_sixout<-sample_betas_fiveout
  sample_betas_sixout$Outlier6<-c(0.01, 0.01, 0.5, 0.9, 0.8, 0.9, 0.9, 1, 1, 1)
  sample_betas_sevenout<-sample_betas_sixout
  sample_betas_sevenout$Outlier7<-c(0.001, 0.001, 0.45, 0.89, 0.82, 0.87, 0.9, 0.9, 0.9, 0.9)
  sample_betas_eightout<-sample_betas_sevenout
  sample_betas_eightout$Outlier8<-c(0.09, 0.0001, 0.53, 0.87, 0.75, 0.93, 0.9, 0.99, 0.99, 0.99)
  sample_betas_nineout<-sample_betas_eightout
  sample_betas_nineout$Outlier9<-c(0.1, 0.02, 0.47, 0.93, 0.85, 0.9, 0.91, 0.87, 0.87, 0.87)
  sample_betas_tenout<-sample_betas_nineout
  sample_betas_tenout$Outlier10<-c(0.15, 0.09, 0.51, 0.86, 0.86, 0.9, 0.86, 0.95, 0.95, 0.95)


  #variance of subsets
  noout<-Call_all_variances(sample_betas)
  oneout<-Call_all_variances(sample_betas_oneout)
  twoout<-Call_all_variances(sample_betas_twoout)
  threeout<-Call_all_variances(sample_betas_threeout)
  fourout<-Call_all_variances(sample_betas_fourout)
  fiveout<-Call_all_variances(sample_betas_fiveout)
  sixout<-Call_all_variances(sample_betas_sixout)
  sevenout<-Call_all_variances(sample_betas_sevenout)
  eightout<-Call_all_variances(sample_betas_eightout)
  nineout<-Call_all_variances(sample_betas_nineout)
  tenout<-Call_all_variances(sample_betas_tenout)



  #which variance measure inoneout and twoout is closest to no outlier 
  data.frame(Variance=colnames(noout),
             OneOutCor=sapply(1:5, function(x) cor(noout[,x], oneout[,x])),
             TwoOutCor=sapply(1:5, function(x) cor(noout[,x], twoout[,x])),
             ThreeOutCor=sapply(1:5, function(x) cor(noout[,x], threeout[,x])),
             FourOutCor=sapply(1:5, function(x) cor(noout[,x], fourout[,x])),
             FiveOutCor=sapply(1:5, function(x) cor(noout[,x], fiveout[,x])),
             SixOutCor=sapply(1:5, function(x) cor(noout[,x], sixout[,x])),
             SevenOutCor=sapply(1:5, function(x) cor(noout[,x], sevenout[,x])),
             EightOutCor=sapply(1:5, function(x) cor(noout[,x], eightout[,x])),
             NineOutCor=sapply(1:5, function(x) cor(noout[,x], nineout[,x])),
             TenOutCor=sapply(1:5, function(x) cor(noout[,x], tenout[,x])))

  #plot outlier data
  sample_betas_tenout$CpG<-rownames(sample_betas_tenout)
  sample_betas_tenout_melt<-melt(sample_betas_tenout)
  sample_betas_tenout_melt$Outlier<-sapply(1:nrow(sample_betas_tenout_melt), function(x) if(sample_betas_tenout_melt$variable[x]%in%c("Outlier", "Outlier2", "Outlier3","Outlier4","Outlier5","Outlier6","Outlier7","Outlier8","Outlier9","Outlier10")){"Outlier"}else{"Inlier"})
  ggplot(sample_betas_tenout_melt, aes(CpG, value, color=Outlier))+geom_point(shape=19)+theme_bw()+
    scale_color_manual(values=c("grey","red"))


```





## Quantile is the best performing variance meausre (comparable to mad but with reference)
```{r}
## All Tissues
Variability_combat_BLBR_Beta_adjusted<-sapply(1:nrow(combat_BLBR_Beta_adjusted), function(y)
  Variation(as.numeric(combat_BLBR_Beta_adjusted[y,])))# across all samples, all tissues
correlations_BLBR$Var<-Variability_combat_BLBR_Beta_adjusted

## Just blood covariance
## Blood
blood<-grep("PBMC", colnames(combat_BLBR_Beta_adjusted))
Covariance_combat_BLBR_Beta_adjusted_blood<-sapply(1:nrow(combat_BLBR_Beta_adjusted), function(y) Variation(as.numeric(combat_BLBR_Beta_adjusted[y,blood])))# across all blood samples
correlations_BLBR_forblood<-correlations_BLBR
correlations_BLBR_forblood$Var<-NULL
correlations_BLBR_forblood$CV_blood<-Covariance_combat_BLBR_Beta_adjusted_blood

#Remove SNPS
correlations_BLBR_forblood<-correlations_BLBR_forblood[which(!(correlations_BLBR_forblood$CpG%in%rownames(SnpatCpG))),]
save(correlations_BLBR_forblood, file="Correlations_BLBR_blood_quantile_variation.RData")

    ##Brains covairance measures are highly correlated with blood
    ##ie when blood varying so it brain
    br7<-grep("BA7", colnames(combat_BLBR_Beta_adjusted))
    Covariance_combat_BLBR_Beta_adjusted_br7<-sapply(1:nrow(combat_BLBR_Beta_adjusted), function(y){
      Variation(as.numeric(combat_BLBR_Beta_adjusted[y,br7]))})# across all br7 samples
    
    br10<-grep("BA10", colnames(combat_BLBR_Beta_adjusted))
    Covariance_combat_BLBR_Beta_adjusted_br10<-sapply(1:nrow(combat_BLBR_Beta_adjusted), function(y){
      Variation(as.numeric(combat_BLBR_Beta_adjusted[y,br10]))})# across all br10 samples
    
    br20<-grep("BA20", colnames(combat_BLBR_Beta_adjusted))
    Covariance_combat_BLBR_Beta_adjusted_br20<-sapply(1:nrow(combat_BLBR_Beta_adjusted), function(y){
      Variation(as.numeric(combat_BLBR_Beta_adjusted[y,br20]))})# across all br20 samples

    cor(Covariance_combat_BLBR_Beta_adjusted_br7,Covariance_combat_BLBR_Beta_adjusted_blood)
    cor(Covariance_combat_BLBR_Beta_adjusted_br10,Covariance_combat_BLBR_Beta_adjusted_blood)
    cor(Covariance_combat_BLBR_Beta_adjusted_br20,Covariance_combat_BLBR_Beta_adjusted_blood)
    
    cor(Covariance_combat_BLBR_Beta_adjusted_br10,Covariance_combat_BLBR_Beta_adjusted_br20)
    cor(Covariance_combat_BLBR_Beta_adjusted_br10,Covariance_combat_BLBR_Beta_adjusted_br7)
    cor(Covariance_combat_BLBR_Beta_adjusted_br20,Covariance_combat_BLBR_Beta_adjusted_br7)

      #What is most variable blood or brain?
      variance_plot<-data.frame(Variance_quantile=c(Covariance_combat_BLBR_Beta_adjusted_br7,
                                                    Covariance_combat_BLBR_Beta_adjusted_br10,
                                                    Covariance_combat_BLBR_Beta_adjusted_br20,
                                                    correlations_BLBR_forblood$CV_blood),
                                Tissue=c(rep("BRAIN7", 441198),
                                         rep("BRAIN10", 441198),
                                         rep("BRAIN20", 441198),
                                         rep("BLOOD", 441198)))
      ggplot(variance_plot, aes(Tissue, log(Variance_quantile)))+
      geom_violin(fill="cornflowerblue")+geom_boxplot(fill="grey",width=0.3)+theme_bw()
      tapply(variance_plot$Variance_quantile, variance_plot$Tissue, mean, na.rm=T)
      save(variance_plot, file="variance_blood_brains.RData")
```

#Threshold CpGs by variance measure
```{r}
load("Correlations_BLBR_blood_quantile_variation.RData")
Cutoffs<-c(0, 0.01,0.05, 0.075,0.1,0.125,0.15,0.175,0.2, 0.225,0.25)

load("Price_annotation.RData")
Chrsex<-annotation$TargetID[which(annotation$CHR%in%c("X","Y"))]#11648

correlations_BLBR_forblood_nosex<-correlations_BLBR_forblood[which(!(correlations_BLBR_forblood$CpG%in%Chrsex)),]#413466

DensityPLot_blood<-lapply(Cutoffs, function(x) {
  varible<-correlations_BLBR_forblood_nosex[which(correlations_BLBR_forblood_nosex$CV_blood>x),]
  varible$CV_cutoff<-x
  varible})
N_blood<-sapply(1:length(Cutoffs), function(x) nrow(DensityPLot_blood[[x]]))
N_blood
DensityPLot_melt_blood<-lapply(1:length(Cutoffs), function(x) melt(DensityPLot_blood[[x]],id=c("CpG","CV_blood","CV_cutoff")))
DensityPLot_plot_blood<-do.call(rbind, DensityPLot_melt_blood)

# Plot
col<-colorRampPalette(brewer.pal(9,"Blues"))(length(Cutoffs))
ggplot(DensityPLot_plot_blood, aes(value, color=as.factor(CV_cutoff)))+geom_density()+
  theme_bw()+facet_wrap(~variable, ncol=1)+scale_color_manual(values=col, name="Variance Cutoff")+
  xlab("Correlation")+ylab("CpG Density")+ylim(0,1.60)
```


```{r}
### SNP DENSITY PLOT
load("SNPS_Correlations_BLBR_blood_quantile_variation.RData")

DensityPLot_blood<-lapply(Cutoffs, function(x) {
  varible<-Snp_correlations_BLBR_forblood[which(Snp_correlations_BLBR_forblood$CV_blood>x),]
  varible$CV_cutoff<-x
  varible})
N_blood<-sapply(1:length(Cutoffs), function(x) nrow(DensityPLot_blood[[x]]))
N_blood
DensityPLot_melt_blood<-lapply(1:length(Cutoffs), function(x) melt(DensityPLot_blood[[x]],id=c("CpG","CV_blood","CV_cutoff")))
DensityPLot_plot_blood<-do.call(rbind, DensityPLot_melt_blood)

# Plot
col<-colorRampPalette(brewer.pal(9,"Blues"))(length(Cutoffs))
ggplot(DensityPLot_plot_blood, aes(value, color=as.factor(CV_cutoff)))+geom_density()+
  theme_bw()+facet_wrap(~variable, ncol=1)+scale_color_manual(values=col, name="Variance Cutoff")+
  xlab("Correlation")+ylab("CpG Density")

## for the mixture model
save(DensityPLot_blood, file="BLBR_DensityPLot_blood_referencerange_SNPs_Xchr.RData")

```


# NULL Correlation
```{r}
load("correlation_unadjustjan22_permutations.RData")

#remove SNPs from all 5 permutations
correlations_BLBR_random$X<-rep(rownames(combat_BLBR_Beta),5)
correlations_BLBR_random<-correlations_BLBR_random[which(!(correlations_BLBR_random$X%in%rownames(SnpatCpG))),]

correlations_BLBR_random$CV_blood<-rep(correlations_BLBR_forblood$CV_blood,5)
colnames(correlations_BLBR_random)<-c("CpG", "BRAIN7", "BRAIN10", "BRAIN20", "CV_blood")

load("Price_annotation.RData")
Chrsex<-annotation$TargetID[which(annotation$CHR%in%c("X","Y"))]#11648

correlations_BLBR_random<-correlations_BLBR_random[which(!(correlations_BLBR_random$CpG%in%Chrsex)),]#413466

DensityPLot_rnd<-lapply(Cutoffs, function(x) {
  varible<-correlations_BLBR_random[which(correlations_BLBR_random$CV_blood>x),]
  varible$CV_cutoff<-x
  varible})
N_rnd<-sapply(1:length(Cutoffs), function(x) nrow(DensityPLot_rnd[[x]]))
DensityPLot_melt_rnd<-lapply(1:length(Cutoffs), function(x) melt(DensityPLot_rnd[[x]],id=c("CpG","CV_blood","CV_cutoff")))
DensityPLot_plot_rnd<-do.call(rbind, DensityPLot_melt_rnd)


# Plot
ggplot(DensityPLot_plot_rnd[sample(1:nrow(DensityPLot_plot_rnd), 2238828),], aes(value, color=as.factor(CV_cutoff)))+geom_density()+
  theme_bw()+facet_wrap(~variable, ncol=1)+scale_color_manual(values=col, name="Variance Cutoff")+
  xlab("Correlation")+ylab("CpG Density")+ylim(0,1.60)
```


## varibility threshold
```{r}
sex_snps<-c(as.character(Chrsex),rownames(SnpatCpG))
length(unique(sex_snps))#32344
SNPS_sex<-Snp_correlations_BLBR_forblood[which(Snp_correlations_BLBR_forblood$CpG%in%sex_snps),]
NO_SNPS_sex<-Snp_correlations_BLBR_forblood[which(!(Snp_correlations_BLBR_forblood$CpG%in%sex_snps)),]

mean(SNPS_sex$CV_blood)
mean(NO_SNPS_sex$CV_blood)

mean(SNPS_sex$BRAIN7)
mean(NO_SNPS_sex$BRAIN7)
mean(SNPS_sex$BRAIN10)
mean(NO_SNPS_sex$BRAIN10)
mean(SNPS_sex$BRAIN20)
mean(NO_SNPS_sex$BRAIN20)

hist(SNPS_sex$CV_blood)
hist(NO_SNPS_sex$CV_blood)

summary(SNPS_sex$CV_blood)
summary(NO_SNPS_sex$CV_blood)
```

## plot just SNPs and sex chr correlation
```{r}
sex_snps<-c(as.character(Chrsex),rownames(SnpatCpG))
SNPS_sex<-Snp_correlations_BLBR_forblood[which(Snp_correlations_BLBR_forblood$CpG%in%sex_snps),]
SNPS_sex_melt<-melt(SNPS_sex, id=c("CpG","CV_blood"))

ggplot(SNPS_sex_melt, aes(value, color=variable))+geom_density()+
  theme_bw()+
  xlab("Correlation")+ylab("CpG Density")


DensityPLot_snp_sex<-lapply(Cutoffs, function(x) {
  varible<-SNPS_sex[which(SNPS_sex$CV_blood>x),]
  varible$CV_cutoff<-x
  varible})
N_rnd<-sapply(1:length(Cutoffs), function(x) nrow(DensityPLot_snp_sex[[x]]))
DensityPLot_snp_sex<-lapply(1:length(Cutoffs), function(x) melt(DensityPLot_snp_sex[[x]],id=c("CpG","CV_blood","CV_cutoff")))
DensityPLot_snp_sex<-do.call(rbind, DensityPLot_snp_sex)

# Plot
col<-colorRampPalette(brewer.pal(9,"Blues"))(length(Cutoffs))
ggplot(DensityPLot_snp_sex, aes(value, color=as.factor(CV_cutoff)))+geom_density()+
  theme_bw()+facet_wrap(~variable, ncol=1)+scale_color_manual(values=col, name="Variance Cutoff")+
  xlab("Correlation")+ylab("CpG Density")

```



###### Mixture model Correlation Threshold
```{r}
# fit model to each brain correlation distribution (2 sub populations); at each covariance cutoff
#Putting on cake
mixMod<-lapply(1:length(DensityPLot_blood), function(cv) lapply(2:4, function(x) normalmixEM(DensityPLot_blood[[cv]][,x],k=2, maxit=500)))  # takes awhile 
save(mixMod,file="mixMod_Bloodcovariancethresholds_referenceReange_SNPs_Xchr.RData")
   
load(file="mixMod_Bloodcovariancethresholds_referenceReange_SNPs_Xchr.RData")
load("BLBR_DensityPLot_blood_referencerange_SNPs_Xchr.RData")
    
# PLOT
# check with plot change mixMod[[#]] (s) to change series
cv<-11
s<-3
pos_cor_pop<-which(mixMod[[cv]][[s]]$mu==max(mixMod[[cv]][[s]]$mu))
plot(mixMod[[cv]][[s]],which=2,xlab2="Correlation")
lines(density(DensityPLot_blood[[cv]][,(s+1)]), lty=2, lwd=3)
    abline(v= mixMod[[cv]][[s]]$mu[pos_cor_pop]-(2*mixMod[[cv]][[s]]$sigma[pos_cor_pop]), col="blue", lwd=3)

cor_threshold<-do.call(rbind,lapply(1:length(mixMod), function(cv) sapply(1:3, function(s) {
  pos_cor_pop<-which(mixMod[[cv]][[s]]$mu==max(mixMod[[cv]][[s]]$mu))#select the highly positively correalted sub population(ie max mu)
  mixMod[[cv]][[s]]$mu[pos_cor_pop]-(2*mixMod[[cv]][[s]]$sigma[pos_cor_pop])})))#what cor value is mu-2sd



# Plot with threshold
cor_threshold<-as.data.frame(cor_threshold)
colnames(cor_threshold)<-c("BRAIN7","BRAIN10","BRAIN20")
cor_threshold$CV_cutoff<-Cutoffs
cor_threshold_melt<-melt(cor_threshold, id="CV_cutoff")


col<-colorRampPalette(brewer.pal(9,"Blues"))(length(mixMod))
ggplot(DensityPLot_plot_blood, aes(value, color=as.factor(CV_cutoff)))+geom_density()+
  theme_bw()+scale_color_manual(values=col, name="Covariance Cutoff (%)")+
  xlab("Correlation")+ylab("CpG Density")+geom_vline(aes(xintercept=value, color=as.factor(CV_cutoff)), data=cor_threshold_melt)+
  facet_grid(variable~.)

#Use the covariance 10 threshold for positively correlation but can then lower variation measure
#emphasize in text that it is a continium, but thresholds were thoughtfully selected
ggplot(DensityPLot_plot_blood[which(DensityPLot_plot_blood$CV_cutoff==0.25),], aes(value))+
  geom_density(color="#08306B")+
  theme_bw()+
  xlab("Correlation")+ylab("CpG Density")+
  geom_vline(aes(xintercept=value, color=as.factor(CV_cutoff)),
             data=cor_threshold_melt[which(cor_threshold_melt$CV_cutoff==0.25),],color="#08306B")+
  facet_grid(variable~.)


# CpG Numbers (Cor at 0.25 and reference range at 0.1; with no SNPS and no sex)
cor_threshold[11,]#thresholds
sapply(1:3, function(br) length(correlations_BLBR_forblood_nosex$CpG[which(correlations_BLBR_forblood_nosex[,(br+1)]>=cor_threshold[11,br])]))#CpGs Passing
sapply(1:3, function(br) length(correlations_BLBR_forblood_nosex$CpG[which(correlations_BLBR_forblood_nosex[,(br+1)]>=cor_threshold[11,br] & correlations_BLBR_forblood_nosex$CV_blood>=0.1)]))#CpGs Passing


#overlap in CpGs passing between three brain regions
Cor_CpGs<-lapply(1:3, function(br) correlations_BLBR_forblood_nosex$CpG[which(correlations_BLBR_forblood_nosex[,(br+1)]>=cor_threshold[11,br] & correlations_BLBR_forblood_nosex$CV>=0.1)])#CpGs Passing
br7_br10<-(intersect(Cor_CpGs[[1]], Cor_CpGs[[2]]))
allbr<-(intersect(br7_br10, Cor_CpGs[[3]]))#2599

save(Cor_CpGs, file="Positively_correlated_CpGs_atreference_range_0.1_corfrom0.25_nosex_nosnp.RData")

## negative
negCor_CpGs<-lapply(1:3, function(br) correlations_BLBR_forblood_nosex$CpG[which(correlations_BLBR_forblood_nosex[,(br+1)]<=(-cor_threshold[11,br]) & correlations_BLBR_forblood_nosex$CV>=0.1)])#CpGs Passing
br7_br10<-(intersect(negCor_CpGs[[1]], negCor_CpGs[[2]]))
allbr<-(intersect(br7_br10, negCor_CpGs[[3]]))#392

save(negCor_CpGs, file="Negatively_correlated_CpGs_atreference_range_0.1_corfrom0.25_nosex_nosnp.RData")

```











```{r}
library(gplots) 

load("Positively_correlated_CpGs_atreference_range_0.1_corfrom0.25_nosex_nosnp.RData")
## Venn diagram
GroupA <- Cor_CpGs[[1]]
GroupB <- Cor_CpGs[[2]]
GroupC <- Cor_CpGs[[3]]

venn(list(BRAIN7=GroupA,BRAIN10=GroupB,BRAIN20=GroupC))

# made in online program and then fixed in inkscape
write.csv(Cor_CpGs[[1]], file="Figures/Venn/BRAIN7.csv")
write.csv(Cor_CpGs[[2]], file="Figures/Venn/BRAIN10.csv")
write.csv(Cor_CpGs[[3]], file="Figures/Venn/BRAIN20.csv")



```



###### Negatvely Correlated CpGs
```{r}
library(gplots) 

load("Negatively_correlated_CpGs_atreference_range_0.1_corfrom0.25_nosex_nosnp.RData")
## Venn diagram
GroupA <- negCor_CpGs[[1]]
GroupB <- negCor_CpGs[[2]]
GroupC <- negCor_CpGs[[3]]

venn(list(BRAIN7=GroupA,BRAIN10=GroupB,BRAIN20=GroupC))

# made in online program and then fixed in inkscape
write.csv(negCor_CpGs[[1]], file="Figures/Venn/negBRAIN7.csv")
write.csv(negCor_CpGs[[2]], file="Figures/Venn/negBRAIN10.csv")
write.csv(negCor_CpGs[[3]], file="Figures/Venn/negBRAIN20.csv")

```




















## presentation plot invariable probes
```{r}
invar_poscor<-correlations_BLBR_forblood$CpG[which(correlations_BLBR_forblood[,2]>=0.7 & correlations_BLBR_forblood$CV<=0.005)]#CpGs Passing
length(invar_poscor)
Comethylation_Plot(correlations_BLBR,combat_BLBR_Beta_adjusted, invar_poscor)



Comethylation_Plot_free<-function(correlations_BLBR, Betas, CpG_Hit_List){
  hits_BLBR<-correlations_BLBR[which(correlations_BLBR$CpG%in%CpG_Hit_List),]
  nrow(hits_BLBR)
  hits_BLBR_PBMC_correlation_melt<-melt(hits_BLBR)
  
  meta$SubNumber<-as.factor(meta$SubjectNumC)
  levels(meta$SubNumber)<-c(1:16)
  BLBR_Beta<-as.data.frame(Betas[which(rownames(Betas)%in%CpG_Hit_List),])
  BLBR_Beta$CpG<-rownames(BLBR_Beta)
  BLBR_Beta<-melt(BLBR_Beta)
  BLBR_Beta<-merge(BLBR_Beta, meta, by.x="variable", by.y="X")
  
  # Comparison highlight
  hits_BLBR$max<-sapply(1:nrow(hits_BLBR), function(x) {
    as.numeric(hits_BLBR[,c(2:4)][x,which(abs(hits_BLBR[x,c(2:4)])==max(abs(hits_BLBR[x,c(2:4)])))][1])})
  hits_BLBR$max_abs<-abs(hits_BLBR$max)
  
  BLBR_Beta$line<-sapply(1:nrow(BLBR_Beta), function(x) {
    hit<-hits_BLBR[which(hits_BLBR$CpG==BLBR_Beta$CpG[x]),]
    region_max_corr<-colnames(hit)[c(2:4)][which(hit[1,c(2:4)]==hit$max[1])]
    if(as.character(BLBR_Beta$TissueType[x])==region_max_corr){"Max_Correlation"}else{"Less Correlated"}})
  
  invisible(sapply(1:nrow(BLBR_Beta), function(x) if(BLBR_Beta$TissueType[x]=="PBMC"){
    BLBR_Beta$line[x]<<-"Max_Correlation"}else{BLBR_Beta$line[x]<<-BLBR_Beta$line[x]}))
  
  #CpG order
  order_cpg<-hits_BLBR$CpG[order(hits_BLBR$max_abs)]
  BLBR_Beta$CpG<-as.factor(BLBR_Beta$CpG)
  BLBR_Beta$CpG<-factor(BLBR_Beta$CpG,levels=rev(order_cpg))
  
  ggplot()+geom_line(aes(SubNumber, value,group=TissueType,color=TissueType,alpha=line),
                     BLBR_Beta, size=1.5)+
    theme_bw()+facet_wrap(~CpG)+
    scale_alpha_manual(values = c(0.25, 1))+
    scale_color_manual(values=c("#fb6a4a","#ef3b2c","#cb181d","cornflowerblue"))}


Comethylation_Plot_free(correlations_BLBR,combat_BLBR_Beta_adjusted, invar_poscor)


```





# presentation plot reference range
```{r}

#reference range plot
Comethylation_Plot_scatter<-function(correlations_BLBR, Betas, CpG_Hit_List){
  hits_BLBR<-correlations_BLBR[which(correlations_BLBR$CpG%in%CpG_Hit_List),]
  nrow(hits_BLBR)
  hits_BLBR_PBMC_correlation_melt<-melt(hits_BLBR)
  
  meta$SubNumber<-as.factor(meta$SubjectNumC)
  levels(meta$SubNumber)<-c(1:16)
  BLBR_Beta<-as.data.frame(Betas[which(rownames(Betas)%in%CpG_Hit_List),])
  BLBR_Beta$CpG<-rownames(BLBR_Beta)
  BLBR_Beta<-melt(BLBR_Beta)
  BLBR_Beta<-merge(BLBR_Beta, meta, by.x="variable", by.y="X")
  
  # Comparison highlight
  hits_BLBR$max<-sapply(1:nrow(hits_BLBR), function(x) {
    as.numeric(hits_BLBR[,c(2:4)][x,which(abs(hits_BLBR[x,c(2:4)])==max(abs(hits_BLBR[x,c(2:4)])))][1])})
  hits_BLBR$max_abs<-abs(hits_BLBR$max)
  
  BLBR_Beta$line<-sapply(1:nrow(BLBR_Beta), function(x) {
    hit<-hits_BLBR[which(hits_BLBR$CpG==BLBR_Beta$CpG[x]),]
    region_max_corr<-colnames(hit)[c(2:4)][which(hit[1,c(2:4)]==hit$max[1])]
    if(as.character(BLBR_Beta$TissueType[x])==region_max_corr){"Max_Correlation"}else{"Less Correlated"}})
  
  invisible(sapply(1:nrow(BLBR_Beta), function(x) if(BLBR_Beta$TissueType[x]=="PBMC"){
    BLBR_Beta$line[x]<<-"Max_Correlation"}else{BLBR_Beta$line[x]<<-BLBR_Beta$line[x]}))
  
  #CpG order
  order_cpg<-hits_BLBR$CpG[order(hits_BLBR$max_abs)]
  BLBR_Beta$CpG<-as.factor(BLBR_Beta$CpG)
  BLBR_Beta$CpG<-factor(BLBR_Beta$CpG,levels=rev(order_cpg))
  BLBR_Beta<-BLBR_Beta[which(BLBR_Beta$TissueType=="PBMC"),]
  ggplot()+geom_point(aes(CpG, value),
                     BLBR_Beta, size=3, shape=21, color="black",fill="cornflowerblue")+
    theme_bw()+
    scale_alpha_manual(values = c(0.25, 1))+
    scale_color_manual(values=c("#fb6a4a","#ef3b2c","#cb181d","cornflowerblue"))+
    geom_hline(yintercept=c(0.9334970, 0.6524934,0.05672657, 0.04220343,0.5044375, 0.3491416))}

samp<-rownames(combat_BLBR_Beta)[sample(1:nrow(combat_BLBR_Beta), 3)]
samp<-c("cg03800150", "cg05136179", "cg19039481")
Comethylation_Plot_scatter(correlations_BLBR,combat_BLBR_Beta_adjusted, samp)

correlations_BLBR_forblood[which(correlations_BLBR_forblood$CpG%in%samp),]


samp_betas<-combat_BLBR_Beta_adjusted[which(rownames(combat_BLBR_Beta_adjusted)%in%samp),]
refrange<-function(x) {c(quantile(x, c(0.9), na.rm=T)[[1]],quantile(x, c(0.1), na.rm=T)[[1]])}
blood<-grep("PBMC", colnames(combat_BLBR_Beta_adjusted))

refrange(as.numeric(samp_betas[1,blood]))
refrange(as.numeric(samp_betas[2,blood]))
refrange(as.numeric(samp_betas[3,blood]))
correlations_BLBR_forblood[which(correlations_BLBR_forblood$CpG%in%samp),]



```



## presentation plot uncorrelated but variable probes
```{r}
uncor<-correlations_BLBR_forblood
uncor$Max<-sapply(1:nrow(correlations_BLBR_forblood), function(x) max(abs(correlations_BLBR_forblood[x,2:4])))

var_uncor<-correlations_BLBR_forblood$CpG[which(abs(uncor$Max)<0.025 & 
                                                  correlations_BLBR_forblood$CV>=0.2)]#CpGs Passing
length(var_uncor)
Comethylation_Plot(correlations_BLBR,combat_BLBR_Beta_adjusted, var_uncor[1:4])
```









############################# SNP in correlation density plot
#Threshold CpGs by variance measure
```{r}
correlations_BLBR<-read.csv("~/Documents/Blood_Brain/Python/correlation_jan22.csv", sep="\t")                       
colnames(correlations_BLBR)<-c("CpG","BRAIN7","BRAIN10","BRAIN20")
correlations_BLBR$CpG<-rownames(combat_BLBR_Beta)#441198      4
load("Correlations_BLBR_blood_quantile_variation.RData")#423384      5

# need to calculate varibility for snp cpgs
varibility_notsnp<-correlations_BLBR_forblood[,c(1,5)]
Snp_correlations_BLBR<-correlations_BLBR[which(!(correlations_BLBR$CpG%in%correlations_BLBR_forblood$CpG)),]#17814     4
Snp_combat_BLBR_Beta_adjusted<-combat_BLBR_Beta_adjusted[which(rownames(combat_BLBR_Beta_adjusted)%in%Snp_correlations_BLBR$CpG),]
Variation<-function(x) {quantile(x, c(0.9), na.rm=T)[[1]]-quantile(x, c(0.1), na.rm=T)[[1]]}
blood<-grep("PBMC", colnames(Snp_combat_BLBR_Beta_adjusted))
Snp_Covariance_combat_BLBR_Beta_adjusted_blood<-sapply(1:nrow(Snp_combat_BLBR_Beta_adjusted), function(y) Variation(as.numeric(Snp_combat_BLBR_Beta_adjusted[y,blood])))# across all blood samples
Snp_correlations_BLBR$CV_blood<-Snp_Covariance_combat_BLBR_Beta_adjusted_blood

Snp_correlations_BLBR_forblood<-rbind(correlations_BLBR_forblood,Snp_correlations_BLBR)#441198      5
Cutoffs<-c(0, 0.01,0.05, 0.075,0.125,0.15,0.175,0.2, 0.225,0.25, 0.275)

save(Snp_correlations_BLBR_forblood, file="SNPS_Correlations_BLBR_blood_quantile_variation.RData")

DensityPLot_blood<-lapply(Cutoffs, function(x) {
  varible<-Snp_correlations_BLBR_forblood[which(Snp_correlations_BLBR_forblood$CV_blood>x),]
  varible$CV_cutoff<-x
  varible})
N_blood<-sapply(1:length(Cutoffs), function(x) nrow(DensityPLot_blood[[x]]))
N_blood
DensityPLot_melt_blood<-lapply(1:length(Cutoffs), function(x) melt(DensityPLot_blood[[x]],id=c("CpG","CV_blood","CV_cutoff")))
DensityPLot_plot_blood<-do.call(rbind, DensityPLot_melt_blood)

# Plot
col<-colorRampPalette(brewer.pal(9,"Blues"))(length(Cutoffs))
ggplot(DensityPLot_plot_blood, aes(value, color=as.factor(CV_cutoff)))+geom_density()+
  theme_bw()+facet_wrap(~variable, ncol=1)+scale_color_manual(values=col, name="Variance Cutoff")+
  xlab("Correlation")+ylab("CpG Density")
```














