Post Normalization Repeat of Quality Control Steps
========================================================
  
## Libraries
```{r}
setwd("~/Documents/Blood_Brain/")
library(reshape)
library(ggplot2)
library(RColorBrewer)
library(mclust)
suppressMessages(library(IlluminaHumanMethylation450k.db))
library(grid)
library(gridExtra)
```

## Load Data
#### Normalized (BMIQ and dasen and probe filtered)
```{r}
load("BLBR_prbFilter_BMIQnrm.RData")
BLBR_Beta<-betas(BLBR)
BLBR_Beta<-as.data.frame(BLBR_Beta)
fix_names<-unlist(lapply(colnames(BLBR_Beta), function(x) gsub(" ","", x , fixed=TRUE)))
colnames(BLBR_Beta)<-fix_names
save(BLBR_Beta, file="BLBR_norm_filtered.RData")
```

## Load Data
#### Normalized (BMIQ and dasen and probe filtered)
```{r}
load("BLBR_norm_filtered.RData")
```


#### Any meta data
```{r}
meta<-read.csv("~/Documents/Blood_Brain/SampleInfo.csv")
fix_names<-unlist(lapply(meta$X, function(x) gsub(" ","", x , fixed=TRUE)))
meta$X<-fix_names
meta<-meta[which(meta$X%in%colnames(BLBR_Beta)),]
meta<-meta[match(colnames(BLBR_Beta), meta$X),]
```



# Sample CpGs for plotting and clustering
```{r}
Beta_sample<-BLBR_Beta[sample(1:nrow(BLBR_Beta), 10000),]
```


## Beta distribtuions 
looking good? Take just a random sample of CpGs for plotting (otherwise so slow)
```{r fig.width=10, fig.height=6}
Beta_sample_melted<- melt(Beta_sample)
#remove NAs before plotting (otherwise get many non-inifnite warnings)
Beta_Plot<-Beta_sample_melted[which(!(is.na(Beta_sample_melted$value))),]
#add meta
Beta_Plot<-merge(Beta_Plot,meta, by.x="variable", by.y="SampleID")

ggplot(Beta_Plot, aes(value, group=variable, color=TissueType))+
  geom_density()+theme_bw()+ guides(color=FALSE) 

## Mval distribtuions 
M_Plot<-Beta_Plot
M_Plot$value<-sapply(1:nrow(M_Plot), function(x) log2(M_Plot$value[x]/(1-M_Plot$value[x])))
# BMIQ is pushing 1842 values to a beta of 4.17969e-05 (M -14.54618) for some reason
ggplot(M_Plot, aes(value, group=variable, color=TissueType))+
                   geom_density()+theme_bw()+xlim(-10,10)
```


# Clustering By Any Meta Data variable
```{r fig.width=10, fig.height=3}
# remove rows with NAs
beta_cluster<-Beta_sample[complete.cases(Beta_sample),]

# plot clustering with color function
plotHclustColors <- function(matrix,leafcolor) {
  colnames(matrix) <- leafcolor
  d <- dist(t(matrix))
  hc <- hclust(d, method = "complete") #single, complete, average, ward
  color<-rep(brewer.pal(12,"Paired"),ceiling(length(unique(leafcolor))/12))
  labelColors <- color[sample(1:length(color),length(unique(leafcolor)))]
  colLab <- function(n) {
    if (is.leaf(n)) {
      a <- attributes(n)
      labCol <- labelColors[which(unique(leafcolor) == a$label)]
      attr(n, "nodePar") <- c(a$nodePar, lab.col=labCol)
    }
    n
  }
  clusDendro <- dendrapply(as.dendrogram(hc), colLab)
  plot(clusDendro)
}

# Plot
plotHclustColors(beta_cluster, meta$TissueType) #all samples
plotHclustColors(beta_cluster, meta$SubjectNumC) #all samples
```




## PCA correlation with meta data
```{r}
# PCA
PCA_full<-princomp(BLBR_Beta[complete.cases(BLBR_Beta),]) # only using the 417619 complete rows for PCA
Loadings<-as.data.frame(unclass(PCA_full$loadings))
vars <- PCA_full$sdev^2
Importance<-vars/sum(vars)


#Restructure meta
meta$Barcode<-as.factor(meta$Barcode)

meta_categorical <- meta[, c(4,5,7,9,13)]  # input column numbers in meta that contain categorical variables
meta_continuous <- meta[, c(10,11,12)]  # input column numbers in meta that contain continuous variables
colnames(meta_categorical) <- c("Barcode", "Section", "Tissue Type","Gender","Array Row")
colnames(meta_continuous) <- c("Age", "PH", "Refrigeration Delay Hours")



heat_scree_plot<-function(Loadings, Importance){
  adjust<-1-Importance[1]
  pca_adjusted<-Importance[2:length(Importance)]/adjust
  pca_df<-data.frame(adjusted_variance=pca_adjusted, PC=seq(1:length(pca_adjusted)))
  
  scree<-ggplot(pca_df[which(pca_df$PC<21),],aes(PC,adjusted_variance))+geom_bar(stat = "identity",color="black",fill="grey")+theme_bw()+
        theme(axis.text = element_text(size =12),
              axis.title = element_text(size =15),
              plot.margin=unit(c(1.25,1.6,0.2,3),"cm"))+ylab("Adjusted Variance")+
    scale_x_continuous(breaks = seq(1,20,1))
  
  
  #### Heat
  ## correlate meta with PCS
  ## Run anova of each PC on each meta data variable


 aov_PC_meta <- lapply(1:ncol(meta_categorical), function(covar) sapply(1:ncol(Loadings), 
        function(PC) summary(aov(Loadings[, PC] ~ meta_categorical[, covar]))[[1]]$"Pr(>F)"[1]))
  cor_PC_meta <- lapply(1:ncol(meta_continuous), function(covar) sapply(1:ncol(Loadings), 
        function(PC) (cor.test(Loadings[, PC], as.numeric(meta_continuous[, 
            covar]), alternative = "two.sided", method = "spearman", na.action = na.omit)$p.value)))
 names(aov_PC_meta) <- colnames(meta_categorical)
    names(cor_PC_meta) <- colnames(meta_continuous)
    aov_PC_meta <- do.call(rbind, aov_PC_meta)
    cor_PC_meta <- do.call(rbind, cor_PC_meta)
    aov_PC_meta <- rbind(aov_PC_meta, cor_PC_meta)
    aov_PC_meta <- as.data.frame(aov_PC_meta)
  
  #adjust
  aov_PC_meta_adjust<-aov_PC_meta[,2:ncol(aov_PC_meta)]
    
  #reshape
  avo<-aov_PC_meta_adjust[,1:20]
  avo_heat_num<-apply(avo,2, as.numeric)
  avo_heat<-as.data.frame(avo_heat_num)
  avo_heat$meta<-rownames(avo)
  avo_heat_melt<-melt(avo_heat, id=c("meta"))
  
  # cluster meta data
  ord <- c(3,4,9,6,7,8,1,2,5)
  meta_var_order<-unique(avo_heat_melt$meta)[rev(ord)]
  avo_heat_melt$meta <- factor(avo_heat_melt$meta, levels = meta_var_order)
  
  # color if sig
  avo_heat_melt$Pvalue<-sapply(1:nrow(avo_heat_melt), function(x) if(avo_heat_melt$value[x]<=0.001){"<=0.001"}else{
    if(avo_heat_melt$value[x]<=0.01){"<=0.01"}else{
      if(avo_heat_melt$value[x]<=0.05){"<=0.05"}else{">0.05"}}})
  
  heat<-ggplot(avo_heat_melt, aes(variable,meta, fill = Pvalue)) +
  geom_tile(color = "black",size=0.5) +
  theme_gray(8)+scale_fill_manual(values=c("#084594","#4292c6","#9ecae1","#deebf7"))+
      theme(axis.text = element_text(size =10, color="black"),
            axis.text.x = element_text(),
          axis.title = element_text(size =15),
          legend.text = element_text(size =14),
          legend.title = element_text(size =12),
          legend.position = c(1, 0.4), legend.justification = c(1,1),
          plot.margin=unit(c(0,2.25,1,1),"cm"))+
    xlab("Adjusted Principle Component")+ylab(NULL)
  
  grid.arrange(scree, heat, ncol=1, widths = c(4, 1), heights = c(2, 4))
}


heat_scree_plot(Loadings, Importance)
```


## PC plot 
```{r}
# Comp 1 (or 0) and 2 (or 1) are tissue
ggplot(Loadings,aes(Comp.2,Comp.3, color=meta$TissueType))+geom_point(shape=19,size=4 )+theme_bw()+
  xlab("PC1 (74.7%)")+ylab("PC2 (5.5%)")+scale_color_manual(values=c("#a50f15","#ef3b2c",
                                                                   "#fc9272","cornflowerblue"),
                                                          name="Tissue")

## no idea what comp3 is, need sva? looks like it is something to do specifically with brain (but not brain region)
ggplot(Loadings,aes(Comp.3,Comp.4, color=as.factor(meta$Gender)))+geom_point(shape=19,size=4 )+theme_bw()+
    xlab("PC2 (5.5%)")+ylab("PC3 (4.2%)")+scale_color_manual(values=c("#f46d43","#66bd63"),
                                                          name="Gender")

ggplot(Loadings,aes(Comp.5,Comp.6, color=meta$Age))+geom_point(shape=19,size=4 )+theme_bw()+
  xlab("PC4 (2.1%)")+ylab("PC5 (1.0%)")+guides(color=guide_legend(title="Age"))


# age in 4th and 5th
ggplot(Loadings,aes(Comp.4,Comp.5, color=meta$Age))+geom_point(shape=19,size=3 )+theme_bw()

# PH and RefrigerationDelayHrs are in many of the PCs should they be removed with combat or included in the linear model?
```


#Combat
```{r}
library(sva)
library(pamr)
library(limma)
Mval<-function(beta) log2(beta/(1-beta))

# BLBR data
pheno = meta
edata = apply(BLBR_Beta, 1, Mval) # need mvalues for combat
edata = as.data.frame(edata)
edata = t(edata)


pheno$Barcode<-as.factor(pheno$Barcode)
pheno$PH<-as.factor(pheno$PH)
pheno$RefrigerationDelayHrs<-as.factor(pheno$RefrigerationDelayHrs)

#Combat
mod = model.matrix(~as.factor(TissueType), data=pheno)

#Plate Row ans section NOT in top 20 PC

#Barcode
batch = pheno$Barcode
combat_BLBR_Beta = ComBat(dat=edata, batch=batch, mod=mod, numCovs=NULL, par.prior=TRUE)
#RefrigerationDelayHrs
batch = pheno$RefrigerationDelayHrs
combat_BLBR_Beta = ComBat(dat=edata, batch=batch, mod=mod, numCovs=NULL, par.prior=TRUE)
#PH
batch = pheno$PH
combat_BLBR_Beta = ComBat(dat=edata, batch=batch, mod=mod, numCovs=NULL, par.prior=TRUE)

#Back to betas
betas<-function(M) 2^M/((2^M)+1)
combat_BLBR_Beta2 = apply(combat_BLBR_Beta, 1, betas) # need mvalues for combat
combat_BLBR_Beta2 = as.data.frame(combat_BLBR_Beta2)
combat_BLBR_Beta2 = t(combat_BLBR_Beta2)
combat_BLBR_Beta<-combat_BLBR_Beta2

save(combat_BLBR_Beta, file="BLBR_Beta_Combatted_Mval_bmiqonly.RData")
```

### Quick PCA
# looks like 0.02 like EL? Not yet, maybe after combat?
```{r}
### Quick PCA
# looks like 0.02 like EL?
pca<-(summary(prcomp(combat_BLBR_Beta))$importance)[2,]

#adjust
adjust<-1-pca[1]
pca_adjusted<-pca[2:length(pca)]/adjust
pca_df<-data.frame(adjusted_variance=pca_adjusted, PC=seq(1:length(pca_adjusted)))
ggplot(pca_df,aes(PC,adjusted_variance))+geom_bar(stat = "identity")+theme_bw()

ggplot(pca_df[which(pca_df$PC<50),],aes(PC,adjusted_variance))+geom_bar(stat = "identity")+theme_bw()
```



# Compare Pre and post normalization and combat REPLICATES
```{r}
load("BLBR_methlylumi_second.RData")#original
load("BLBR_norm_filtered.RData") # BMIQ
load("BLBR_Beta_Combatted_Mval_bmiqonly.RData") # Includes replicates


beta_BLBR.2<-betas(BLBR.2)
colnames(beta_BLBR.2)<-colnames(combat_BLBR_Beta)
beta_BLBR.2_bmiq<-BLBR_Beta

meta$SampleID<-colnames(beta_BLBR.2)
replicates<-data.frame(Sample_ID=meta$SampleID[which(meta$Replicate=="Y")],
                       X=meta$X[which(meta$Replicate=="Y")])
replicates$Pair<-c("PBMC169","BA7250","PBMC250","BA7250","BA10248","PBMC169","BA10248","PBMC250")
                   

original_rep<-beta_BLBR.2[,which(colnames(beta_BLBR.2)%in%replicates$Sample_ID)]
bmiq_rep<-beta_BLBR.2_bmiq[,which(colnames(beta_BLBR.2_bmiq)%in%replicates$Sample_ID)]
combat_rep<-combat_BLBR_Beta[,which(colnames(combat_BLBR_Beta)%in%replicates$Sample_ID)]


###### Correlatioon
Data_cors<-function(df) {data.frame(Comparison=c("PBMC169", "BA7250",  "PBMC250", "BA10248"), 
                                    Correlation=c(cor(df[,1],df[,6], use="complete.obs"),
                                                  cor(df[,2],df[,4], use="complete.obs"),
                                                  cor(df[,3],df[,8], use="complete.obs"),
                                                  cor(df[,5],df[,7], use="complete.obs")))}

original_rep_cor<-Data_cors(original_rep)
bmiq_rep_cor<-Data_cors(bmiq_rep)
combat_rep_cor<-Data_cors(combat_rep)

original_rep_cor$Data<-"Original"
bmiq_rep_cor$Data<-"BMIQ Norm"
combat_rep_cor$Data<-"BMIQ Norm Combat"

rep_cor<-rbind(original_rep_cor,bmiq_rep_cor,combat_rep_cor)
rep_cor$Data <- factor(rep_cor$Data, levels=c("Original","BMIQ Norm", "BMIQ Norm Combat"))
ggplot(rep_cor, aes(Data, Correlation, group=Comparison, color=Comparison))+geom_line(size=2)+theme_bw()+ylab("Replicate Correlation")

## RMSE
library(hydroGOF)
Data_cors<-function(df) {data.frame(Comparison=c("PBMC169", "BA7250",  "PBMC250", "BA10248"), 
                                    Correlation=c(rmse(df[,1],df[,6], use="complete.obs"),
                                                  rmse(df[,2],df[,4], use="complete.obs"),
                                                  rmse(df[,3],df[,8], use="complete.obs"),
                                                  rmse(df[,5],df[,7], use="complete.obs")))}

original_rep_cor<-Data_cors(original_rep)
bmiq_rep_cor<-Data_cors(bmiq_rep)
combat_rep_cor<-Data_cors(combat_rep)

original_rep_cor$Data<-"Original"
bmiq_rep_cor$Data<-"BMIQ Norm"
combat_rep_cor$Data<-"BMIQ Norm Combat"

rep_cor<-rbind(original_rep_cor,bmiq_rep_cor,combat_rep_cor)
rep_cor$Data <- factor(rep_cor$Data, levels=c("Original","BMIQ Norm", "BMIQ Norm Combat"))
ggplot(rep_cor, aes(Data, Correlation, group=Comparison, color=Comparison))+geom_line(size=2)+theme_bw()+ylab("Root Mean Squre Error")





```

# PCA after COMBAT
```{r}
## load BLBR data, meta and Hannum
```{r}
# Remove Replicates
rm_replicates<-c("BA7250rep", "PBMC169rep", "BA102482", "PBMC250rep")
combat_BLBR_Beta<-combat_BLBR_Beta[,which(!(colnames(combat_BLBR_Beta)%in%rm_replicates))]# 460199 n=66

save(combat_BLBR_Beta, file="combat_BLBR_Beta_noreplicates.RData")

meta<-meta[which(meta$X%in%colnames(combat_BLBR_Beta)),]
meta<-meta[match(colnames(combat_BLBR_Beta), meta$X),]

PCA_full_combat<-princomp(combat_BLBR_Beta[complete.cases(combat_BLBR_Beta),])
Loadings_combat<-as.data.frame(unclass(PCA_full_combat$loadings))
vars_combat <- PCA_full_combat$sdev^2
Importance_combat<-vars_combat/sum(vars_combat)

meta$Barcode<-as.factor(meta$Barcode)

meta_categorical <- meta[, c(4,5,7,9,13)]  # input column numbers in meta that contain categorical variables
meta_continuous <- meta[, c(10,11,12)]  # input column numbers in meta that contain continuous variables
colnames(meta_categorical) <- c("Barcode", "Section", "Tissue Type","Gender","Array Row")
colnames(meta_continuous) <- c("Age", "PH", "Refrigeration Delay Hours")


heat_scree_plot(Loadings_combat, Importance_combat)
```


## meta data correlation
```{r}
Meta_correlation<-lapply(c(4:13), function(x) as.numeric(meta[,x]))
Meta_correlation<-as.data.frame(do.call(cbind, Meta_correlation))
colnames(Meta_correlation)<-colnames(meta)[4:13]

correlation<-cor(Meta_correlation, use="complete.obs", method="spearman") 
correlation_melt<-melt(correlation)
cols <- brewer_pal(pal = "RdBu")(5)


ggplot(correlation_melt, aes(X1,X2, fill = value)) +
  geom_tile(color = "black",size=0.5) +
  theme_gray(8)+theme(axis.text = element_text(size =10, color="black"),
          axis.title = element_text(size =15),
          axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_fill_gradientn(colours = cols, 
                         values = rescale(c(-0.65, 0,0.65)),
                         guide = "colorbar", limits=c(-0.65, 0.65))
```




